{% extends 'base.html' %}

{% block body %}
    <h1>Email Sending Process Completed</h1>
    <p>All emails have been processed for folder: {{ folder }}</p>
    <h2>Failed Emails</h2>
    <ul id="failed-emails-list">
        <!-- Failed emails will be populated here dynamically -->
    </ul>
    <h2>Error Details</h2>
    <ul id="error-details-list">
        <!-- Error details will be populated here dynamically -->
    </ul>
    <div id="pagination-controls">
        <button onclick="prevPage('logs')">Previous Logs</button>
        <button onclick="nextPage('logs')">Next Logs</button>
        <button onclick="prevPage('errors')">Previous Errors</button>
        <button onclick="nextPage('errors')">Next Errors</button>
        <p id="logs-page-info"></p>
        <p id="errors-page-info"></p>
    </div>
    <h2>What do you want to do next?</h2>
    <form action="/send_mail/" method="post">
        <input type="hidden" name="folder" value="{{ folder }}">
        <button type="submit">Retry Sending All Emails</button>
    </form>
    <div id="actions">
        <form action="/export_logs" method="post">
            <input type="hidden" name="task_id" value="{{ task_id }}">
            <button type="submit">Export Logs and Errors</button>
        </form>
    </div>

    <script>
        let logsPage = 1;
        let errorsPage = 1;
        const task_id = "{{ task_id }}";

        function loadLogs(page) {
            fetch(`/retry_logs/?task_id=${task_id}&page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const logsList = document.getElementById('failed-emails-list');
                    logsList.innerHTML = '';
                    data.logs.forEach(log => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>Timestamp:</strong> ${log.timestamp}<br>
                            <strong>Email:</strong> ${log.email}<br>
                            <strong>File:</strong> ${log.file}<br>
                            <strong>Message:</strong> ${log.message}<br><br>
                        `;
                        logsList.appendChild(li);
                    });
                    document.getElementById('logs-page-info').textContent = `Page ${page} of ${data.total_pages}`;
                });
        }

        function loadErrors(page) {
            fetch(`/retry_errors/?task_id=${task_id}&page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const errorsList = document.getElementById('error-details-list');
                    errorsList.innerHTML = '';
                    data.errors.forEach(error => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>Timestamp:</strong> ${error.timestamp}<br>
                            <strong>Email:</strong> ${error.email}<br>
                            <strong>File:</strong> ${error.file}<br>
                            <strong>Error:</strong> ${error.error}<br><br>
                        `;
                        errorsList.appendChild(li);
                    });
                    document.getElementById('errors-page-info').textContent = `Page ${page} of ${data.total_pages}`;
                });
        }

        function nextPage(type) {
            if (type === 'logs') {
                logsPage++;
                loadLogs(logsPage);
            } else if (type === 'errors') {
                errorsPage++;
                loadErrors(errorsPage);
            }
        }

        function prevPage(type) {
            if (type === 'logs' && logsPage > 1) {
                logsPage--;
                loadLogs(logsPage);
            } else if (type === 'errors' && errorsPage > 1) {
                errorsPage--;
                loadErrors(errorsPage);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadLogs(logsPage);
            loadErrors(errorsPage);
        });
    </script>
{% endblock %}